# Настройка DonationAlerts

## Описание
Интеграция с DonationAlerts позволяет показывать аватары донатеров на экране. Когда зритель, у которого есть аватар в системе, делает донат через DonationAlerts, его аватар появляется аналогично команде `!start`.

## Настройка

### 1. Получение API ключа
1. Перейдите в [DonationAlerts](https://www.donationalerts.com/)
2. Войдите в свой аккаунт
3. Перейдите в **Настройки** → **API**
4. Нажмите **"Создать новый токен"**
5. Выберите права доступа: **"alerts"** (для получения донатов)
6. Скопируйте полученный токен

### 2. Настройка API ключа
**Вариант 1 (рекомендуемый) - через переменные окружения:**
```bash
export DA_API_KEY="ваш_токен_здесь"
export DA_APP_ID="ваш_app_id_здесь"
```

**Вариант 2 - прямо в коде:**
Отредактируйте файл `/lib/donationalerts.js` и замените:
```javascript
const DA_API_KEY = process.env.DA_API_KEY || 'ваш_новый_токен_здесь';
const DA_APP_ID = process.env.DA_APP_ID || 'ваш_app_id_здесь';
```

**Текущие настройки (НЕ РАБОТАЮТ):**
- API ключ: `vryYRw8gwJHHCHZsSyVjV7jFy5orvn4Y4G3zFoTb` ❌
- ID приложения: `16136`

### 3. Запуск интеграции
1. Запустите сервер: `npm start`
2. Перейдите на страницу успешной авторизации
3. Нажмите кнопку "Запустить DonationAlerts"
4. Система начнет опрашивать API DonationAlerts каждые 10 секунд

### 4. Настройка webhook (опционально)
Вместо опроса API можно настроить webhook:
1. В настройках DonationAlerts укажите URL: `https://yourdomain.com/webhook/donationalerts`
2. Выберите события: "Новое пожертвование"
3. Сохраните настройки

## Как это работает

1. **Поиск пользователя**: Система ищет пользователя по нику донатера (без учета регистра)
2. **Создание аватара**: Если у пользователя нет аватара, создается стандартный
3. **Показ аватара**: Аватар появляется на экране аналогично команде `!start`
4. **Эффект подарка**: Через 2 секунды показывается эффект подарка с информацией о донате

## API эндпоинты

- `POST /api/donationalerts/start` - Запустить опрос DonationAlerts
- `POST /api/donationalerts/stop` - Остановить опрос DonationAlerts
- `POST /api/donationalerts/test` - Тестовый запрос (обработать последний донат)
- `POST /webhook/donationalerts` - Webhook для DonationAlerts

## Логирование

Все действия логируются в консоль с префиксом `[DA]`:
- Обработка донатов
- Поиск пользователей
- Создание аватаров
- Ошибки API

## Требования

- Пользователь должен быть зарегистрирован в системе (через Twitch OAuth)
- Ник в DonationAlerts должен совпадать с логином в системе (без учета регистра)
- Сервер должен быть доступен из интернета для webhook

## Устранение неполадок

1. **Аватар не появляется**: Проверьте, что пользователь зарегистрирован в системе
2. **Ошибки API**: Проверьте правильность API ключа
3. **Webhook не работает**: Убедитесь, что сервер доступен из интернета
4. **Кэш пользователей**: При добавлении новых пользователей кэш обновляется автоматически
